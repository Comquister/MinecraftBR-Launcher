<?php
$pasta=__DIR__;$nomeZip='backup_'.date("Ymd_His");$ignorar=$_GET['ignorar']??'';
if(!is_dir($pasta)){http_response_code(404);echo json_encode(['erro'=>'Pasta não encontrada']);exit;}
if(!extension_loaded('zip')){http_response_code(500);echo json_encode(['erro'=>'Extensão ZIP não está disponível']);exit;}
try{$arquivoZip=tempnam(sys_get_temp_dir(),'backup').'.zip';$zip=new ZipArchive();if($zip->open($arquivoZip,ZipArchive::CREATE|ZipArchive::OVERWRITE)!==TRUE)throw new Exception('Não foi possível criar o ZIP');
function adicionarArquivos($dir,$zip,$base,$ignorar){$somente=false;if($ignorar&&$ignorar[0]=='!'){$somente=substr($ignorar,1);} $it=new RecursiveIteratorIterator(new RecursiveDirectoryIterator($dir,RecursiveDirectoryIterator::SKIP_DOTS),RecursiveIteratorIterator::SELF_FIRST);foreach($it as $item){if($item->getFilename()==='index.php'||strpos($item->getFilename(),'.tmp')!==false)continue;$full=str_replace('\\','/',$item->getRealPath());$rel=ltrim(str_replace(str_replace('\\','/',$base),'',$full),'/');if(!$rel||$rel=='.')continue;if($somente){if(strpos($full,'/'.$somente.'/')===false)continue;}else{if($ignorar&&strpos($full,'/'.$ignorar.'/')!==false)continue;}if($item->isDir())$zip->addEmptyDir($rel.'/');else $zip->addFile($item->getRealPath(),$rel);}}
$base=rtrim(str_replace('\\','/',realpath($pasta)),'/').'/';adicionarArquivos($pasta,$zip,$base,$ignorar);$zip->close();if(!file_exists($arquivoZip))throw new Exception('Falha ao criar o ZIP');header('Content-Type: application/zip');header('Content-Disposition: attachment; filename="'.$nomeZip.'.zip"');header('Content-Length: '.filesize($arquivoZip));header('Cache-Control: no-cache, must-revalidate');header('Pragma: public');readfile($arquivoZip);unlink($arquivoZip);}catch(Exception $e){if(isset($arquivoZip)&&file_exists($arquivoZip))unlink($arquivoZip);http_response_code(500);header('Content-Type: application/json');echo json_encode(['erro'=>'Erro ao criar o ZIP','mensagem'=>$e->getMessage()]);}
?>
